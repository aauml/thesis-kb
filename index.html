<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thesis Monitor — EU AI Act ↔ NIST AI RMF</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #FAFAF8;
    color: #111;
    min-height: 100vh;
  }
  a { color: #1E40AF; text-decoration: none; }
  a:hover { text-decoration: underline; }
  button { font-family: inherit; cursor: pointer; }
  .container { max-width: 760px; margin: 0 auto; padding: 0 24px; }

  /* ── Header ── */
  header { border-bottom: 2px solid #111; padding: 32px 0 20px; }
  .header-top {
    display: flex; justify-content: space-between; align-items: baseline;
    margin-bottom: 4px;
  }
  h1 { font-family: Georgia, serif; font-size: 34px; font-weight: 300; letter-spacing: -0.5px; }
  .header-sub { font-family: Georgia, serif; font-size: 14px; color: #6B7280; font-style: italic; margin-bottom: 16px; }
  .header-stats { display: flex; gap: 20px; font-size: 13px; color: #6B7280; flex-wrap: wrap; }
  .header-stats strong { color: #111; }
  .refresh-area { display: flex; gap: 14px; align-items: baseline; }
  .last-fetch { font-size: 11px; color: #9CA3AF; }
  .btn-refresh { font-size: 12px; font-weight: 600; color: #1E40AF; background: none; border: none; padding: 0; }
  .btn-refresh:disabled { color: #9CA3AF; cursor: default; }

  /* ── Importance filters ── */
  .imp-filters {
    display: flex; gap: 6px; align-items: center;
    padding-top: 14px; flex-wrap: wrap;
  }
  .btn-imp {
    padding: 4px 10px; font-size: 11px; font-weight: 600;
    letter-spacing: 0.04em; text-transform: uppercase;
    border: 1px solid #E5E7EB; border-radius: 3px;
    background: #fff; color: #6B7280;
  }
  .btn-imp.active-ALTA  { background: #DC2626; border-color: #DC2626; color: #fff; }
  .btn-imp.active-MEDIA { background: #D97706; border-color: #D97706; color: #fff; }
  .btn-imp.active-BAJA  { background: #9CA3AF; border-color: #9CA3AF; color: #fff; }

  /* ── Search bar ── */
  .search-bar {
    padding: 10px 0 0;
    display: flex; gap: 8px; align-items: center;
  }
  .search-wrap {
    position: relative; display: flex; align-items: center;
  }
  .search-wrap input[type=text] {
    width: 240px;
    padding: 7px 30px 7px 11px; font-size: 13px;
    border: 1px solid #E5E7EB; border-radius: 4px;
    background: #fff; outline: none; font-family: inherit;
  }
  .search-wrap input[type=text]:focus { border-color: #93C5FD; }
  .btn-clear-x {
    position: absolute; right: 7px;
    background: none; border: none;
    font-size: 13px; color: #9CA3AF;
    line-height: 1; padding: 0; cursor: pointer; display: none;
  }
  .btn-clear-x:hover { color: #374151; }
  .btn-search {
    padding: 6px 14px; font-size: 13px; font-weight: 500;
    border: 1px solid #1E40AF; border-radius: 4px;
    background: #1E40AF; color: #fff;
  }
  .btn-search:hover { background: #1e3a8a; border-color: #1e3a8a; }
  select {
    padding: 6px 6px; font-size: 12px;
    border: 1px solid #E5E7EB; border-radius: 4px;
    background: #fff; color: #374151;
    font-family: inherit; cursor: pointer;
    max-width: 140px;
  }
  .btn-clear-filters {
    background: none; border: 1px solid #E5E7EB; border-radius: 3px;
    font-size: 11px; color: #9CA3AF;
    padding: 4px 8px; cursor: pointer; line-height: 1;
  }
  .btn-clear-filters:hover { border-color: #DC2626; color: #DC2626; }
  .filter-count { font-size: 12px; color: #9CA3AF; padding: 6px 0 0; }

  /* ── Export bar ── */
  .export-bar { padding: 10px 0 0; display: flex; gap: 10px; align-items: center; }
  .btn-export {
    font-size: 11px; color: #6B7280; background: none;
    border: 1px solid #E5E7EB; border-radius: 4px; padding: 4px 10px;
  }
  .btn-export:hover { border-color: #93C5FD; color: #1E40AF; }

  /* ── Cards ── */
  main { padding: 0 0 80px; }
  article {
    border-bottom: 1px solid #E5E7EB;
    padding: 20px 0;
    cursor: pointer;
  }
  article:hover { background: #F9FAFB; margin: 0 -8px; padding-left: 8px; padding-right: 8px; }

  .card-top-line {
    display: flex; flex-wrap: wrap; align-items: center;
    gap: 0; margin-bottom: 7px; font-size: 11px; line-height: 1.8;
  }
  .card-imp {
    display: inline-flex; align-items: center;
    padding: 2px 10px; border-radius: 3px;
    font-size: 11px; font-weight: 700;
    letter-spacing: 0.06em; text-transform: uppercase;
    line-height: 1.6; margin-right: 8px; flex-shrink: 0;
  }
  .imp-ALTA  { background: #DC2626; color: #fff; }
  .imp-MEDIA { background: #D97706; color: #fff; }
  .imp-BAJA  { background: #9CA3AF; color: #fff; }

  .card-title {
    font-family: Georgia, serif;
    font-size: 19px; font-weight: 400; line-height: 1.35;
    margin: 0 0 5px; color: #111;
  }
  .card-byline {
    font-size: 12px; color: #9CA3AF;
    display: flex; gap: 0; flex-wrap: wrap; align-items: center;
  }
  .card-byline .scholar { color: #6B7280; font-weight: 500; }
  .card-byline .lang { text-transform: uppercase; font-weight: 600; font-size: 11px; }
  .meta-sep { color: #D1D5DB; padding: 0 5px; user-select: none; }

  .meta-capa-teorica    { color: #1E40AF; font-weight: 500; }
  .meta-capa-analitica  { color: #166534; font-weight: 500; }
  .meta-capa-evaluativa { color: #6B21A8; font-weight: 500; }

  .meta-action { font-weight: 600; letter-spacing: 0.03em; }
  .meta-action-REFERENCE { color: #1E40AF; }
  .meta-action-CONTEXT   { color: #9CA3AF; }
  .meta-action-FOLLOW-UP { color: #D97706; }
  .meta-action-URGENT    { color: #DC2626; }

  .meta-type { color: #9CA3AF; letter-spacing: 0.04em; }

  .meta-tier { font-weight: 600; }
  .meta-tier-1 { color: #1E3A8A; }
  .meta-tier-2 { color: #065F46; }
  .meta-tier-3 { color: #92400E; }

  .card-body {
    margin-top: 14px; padding-left: 14px;
    border-left: 2px solid #E5E7EB;
    display: none;
  }
  .card-body.open { display: block; }
  .card-body p { font-size: 14px; line-height: 1.7; margin: 0 0 10px; color: #4B5563; }
  .card-body p.thesis { color: #111; font-weight: 500; }
  .card-body .read-link { font-size: 13px; font-weight: 500; }

  /* ── Pagination ── */
  .pagination {
    display: flex; gap: 8px; justify-content: center;
    padding: 32px 0 0; align-items: center; flex-wrap: wrap;
  }
  .btn-page {
    padding: 7px 12px; font-size: 13px;
    border: 1px solid #E5E7EB; border-radius: 4px;
    background: #fff; color: #374151;
  }
  .btn-page:hover:not(:disabled) { border-color: #93C5FD; }
  .btn-page.current { background: #1E40AF; border-color: #1E40AF; color: #fff; font-weight: 600; cursor: default; }
  .btn-page:disabled { color: #D1D5DB; background: #F9FAFB; cursor: default; }
  .ellipsis { font-size: 13px; color: #9CA3AF; padding: 0 4px; }

  /* ── States ── */
  .state-msg { text-align: center; padding: 60px 0; color: #9CA3AF; font-size: 14px; }
  .error-box {
    margin-top: 24px; padding: 14px 16px;
    background: #FEF2F2; border: 1px solid #FECACA;
    border-radius: 6px; font-size: 13px; color: #991B1B; line-height: 1.6;
  }
  .error-box strong { display: block; margin-bottom: 4px; }
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <header>
    <div class="header-top">
      <h1>Thesis Monitor</h1>
      <div class="refresh-area">
        <span class="last-fetch" id="lastFetch"></span>
        <button class="btn-refresh" id="btnRefresh" onclick="refresh()">↻ Refresh</button>
      </div>
    </div>
    <p class="header-sub">EU AI Act ↔ NIST AI RMF Interoperability</p>
    <div class="header-stats" id="headerStats"><span>Loading…</span></div>
  </header>

  <!-- Search bar -->
  <div class="search-bar">
    <div class="search-wrap">
      <input type="text" id="searchInput" placeholder="Search title, scholar, topic…"
             onkeydown="if(event.key==='Enter')submitSearch()"
             oninput="updateXBtn()" />
      <button class="btn-clear-x" id="btnClearX" onclick="clearSearch()" title="Clear search">✕</button>
    </div>
    <button class="btn-search" onclick="submitSearch()">Search</button>
  </div>

  <!-- Filters row: importance + sort + clear all -->
  <div class="imp-filters">
    <button class="btn-imp" id="btn-ALTA"  onclick="toggleImp('ALTA')">Alta</button>
    <button class="btn-imp" id="btn-MEDIA" onclick="toggleImp('MEDIA')">Media</button>
    <button class="btn-imp" id="btn-BAJA"  onclick="toggleImp('BAJA')">Baja</button>
    <select id="selSort" onchange="applySort()">
      <option value="found-desc" selected>Found: newest</option>
      <option value="found-asc">Found: oldest</option>
      <option value="date-desc">Published: newest</option>
      <option value="date-asc">Published: oldest</option>
      <option value="importance">By importance</option>
    </select>
    <button class="btn-clear-filters" id="btnClearFilters" onclick="clearAllFilters()" title="Clear all filters" style="display:none">✕</button>
  </div>
  <p class="filter-count" id="filterCount"></p>

  <!-- Export -->
  <div class="export-bar">
    <button class="btn-export" onclick="exportMarkdown()">⬇ Copy as Markdown</button>
  </div>

  <!-- Main -->
  <main id="main"><div class="state-msg">Loading…</div></main>
  <div class="pagination" id="pagination"></div>

</div>

<script>
// ── Config ───────────────────────────────────────────────────
const API_URL    = "https://script.google.com/macros/s/AKfycbzk2vhu-qcKFBPqEImKGEZKSitpVZv1IQQEv5ZzG7pNfo-iPUWfvSoLWWnkoc8d8PQQ/exec";
const PAGE_LIMIT = 50;

// ── State ────────────────────────────────────────────────────
let state = {
  page: 1, search: "", importance: "", sort: "found-desc",
  rows: [],
  total: 0, total_pages: 1, has_next: false, has_prev: false,
  loading: false, lastFetch: null,
};
let expandedIds = new Set();

// ── Build URL ────────────────────────────────────────────────
function buildUrl() {
  let url = API_URL + "?action=getPage"
    + "&page=" + state.page
    + "&limit=" + PAGE_LIMIT
    + "&sort=" + encodeURIComponent(state.sort);
  if (state.importance) url += "&importance=" + encodeURIComponent(state.importance);
  if (state.search)     url += "&search="     + encodeURIComponent(state.search);
  return url;
}

// ── JSONP ────────────────────────────────────────────────────
function jsonp(url) {
  return new Promise((resolve, reject) => {
    const cbName = "_cb_" + Math.random().toString(36).slice(2);
    const timer = setTimeout(() => { delete window[cbName]; reject(new Error("Request timed out")); }, 25000);
    window[cbName] = data => { clearTimeout(timer); delete window[cbName]; resolve(data); };
    const s = document.createElement("script");
    s.src = url + "&callback=" + cbName;
    s.onerror = () => { clearTimeout(timer); delete window[cbName]; reject(new Error("Network error")); };
    document.head.appendChild(s);
  });
}

// ── Fetch ────────────────────────────────────────────────────
async function fetchData() {
  if (state.loading) return;
  state.loading = true;
  setRefreshBtn(true);
  renderMain('<div class="state-msg">Loading…</div>');
  document.getElementById("pagination").innerHTML = "";

  try {
    const data = await jsonp(buildUrl());
    if (data.error) throw new Error(data.error);

    state.total       = data.total;
    state.total_pages = data.total_pages;
    state.has_next    = data.has_next;
    state.has_prev    = data.has_prev;
    state.page        = data.page || state.page;
    state.lastFetch   = new Date();
    state.rows        = data.rows || [];

    renderHeader(data.stats || null);
    renderFlat();
    renderPagination();
  } catch(e) {
    renderMain(`<div class="error-box"><strong>Could not load data.</strong> ${e.message}</div>`);
  }

  state.loading = false;
  setRefreshBtn(false);
  if (state.lastFetch)
    document.getElementById("lastFetch").textContent =
      state.lastFetch.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
}

function refresh() { fetchData(); }

// ── Filters ──────────────────────────────────────────────────
function toggleImp(imp) {
  ["ALTA","MEDIA","BAJA"].forEach(i => {
    const btn = document.getElementById("btn-" + i);
    const wasActive = btn.classList.contains("active-" + i);
    btn.className = "btn-imp" + (i === imp && !wasActive ? " active-" + i : "");
  });
  state.importance = document.getElementById("btn-ALTA").classList.contains("active-ALTA")   ? "ALTA"
                   : document.getElementById("btn-MEDIA").classList.contains("active-MEDIA") ? "MEDIA"
                   : document.getElementById("btn-BAJA").classList.contains("active-BAJA")   ? "BAJA" : "";
  state.page = 1;
  updateFiltersClearBtn();
  fetchData();
}

function submitSearch() {
  state.search = document.getElementById("searchInput").value.trim();
  state.page = 1;
  updateXBtn();
  updateFiltersClearBtn();
  fetchData();
}

function clearSearch() {
  document.getElementById("searchInput").value = "";
  state.search = "";
  state.page = 1;
  updateXBtn();
  updateFiltersClearBtn();
  fetchData();
}

function clearAllFilters() {
  document.getElementById("searchInput").value = "";
  document.getElementById("selSort").value = "found-desc";
  ["ALTA","MEDIA","BAJA"].forEach(i => document.getElementById("btn-" + i).className = "btn-imp");
  state.search = ""; state.importance = ""; state.sort = "found-desc"; state.page = 1;
  updateXBtn();
  updateFiltersClearBtn();
  fetchData();
}

function updateXBtn() {
  const val = document.getElementById("searchInput").value;
  document.getElementById("btnClearX").style.display = val ? "block" : "none";
}

function updateFiltersClearBtn() {
  const active = state.importance || state.search;
  document.getElementById("btnClearFilters").style.display = active ? "inline" : "none";
}

function applySort() {
  state.sort = document.getElementById("selSort").value;
  state.page = 1;
  fetchData();
}

function goPage(p) { state.page = p; fetchData(); }

// ── Render ───────────────────────────────────────────────────
function renderHeader(stats) {
  const el = document.getElementById("headerStats");
  if (stats) {
    el.innerHTML = `
      <span><strong>${stats.total_all}</strong> total</span>
      <span style="color:#DC2626;font-weight:600">${stats.alta}</span> Alta ·
      <span style="color:#D97706;font-weight:600">${stats.media}</span> Media ·
      <span style="color:#9CA3AF;font-weight:600">${stats.baja}</span> Baja
      ${(state.search || state.importance) ? `<span>· <strong>${state.total}</strong> matching</span>` : ""}
    `;
  } else {
    el.innerHTML = `<span><strong>${state.total}</strong> ${(state.search || state.importance) ? "matching" : "total"} items</span>`;
  }
  document.getElementById("filterCount").textContent = state.total_pages > 1
    ? `Page ${state.page} of ${state.total_pages} · ${state.total} items` : "";
}

function renderFlat() {
  if (!state.rows.length) {
    renderMain('<div class="state-msg">No results.</div>');
    return;
  }
  renderMain(state.rows.map((item, i) => renderCard(item, "c-" + state.page + "-" + i)).join(""));
}

// ── Card ─────────────────────────────────────────────────────
function renderCard(item, id) {
  const imp    = item.importance || "BAJA";
  const act    = item.action_tag || "CONTEXT";
  const tier   = String(item.tier ?? "").trim();
  const isOpen = expandedIds.has(id);

  // Byline
  const bylineParts = [
    item.source || "",
    item.date_published ? formatDate(item.date_published) : "",
    item.scholar ? `<span class="scholar">${item.scholar}</span>` : "",
    item.language && item.language !== "en" ? `<span class="lang">${item.language}</span>` : "",
  ].filter(Boolean);
  const byline = bylineParts.join('<span class="meta-sep">·</span>');

  // Meta line: capas · action · type · tier
  const metaParts = [];
  (item.capa || "").split(",").forEach(c => {
    c = c.trim().toLowerCase();
    if (!c) return;
    const cls   = c.includes("teór") || c.includes("teor") ? "meta-capa-teorica"
                : c.includes("analí") || c.includes("anali") ? "meta-capa-analitica"
                : c.includes("eval") ? "meta-capa-evaluativa" : "meta-capa-teorica";
    const label = c.includes("teór") || c.includes("teor") ? "Teórica"
                : c.includes("analí") || c.includes("anali") ? "Analítica"
                : c.includes("eval") ? "Evaluativa" : c;
    metaParts.push(`<span class="${cls}">${label}</span>`);
  });

  const ACT_LABELS = { REFERENCE: "Reference", CONTEXT: "Context", "FOLLOW-UP": "Follow-up", URGENT: "Urgent" };
  metaParts.push(`<span class="meta-action meta-action-${act}">${ACT_LABELS[act] || act}</span>`);
  if (item.content_type) metaParts.push(`<span class="meta-type">${item.content_type}</span>`);
  if (tier) metaParts.push(`<span class="meta-tier meta-tier-${tier}">T${tier}</span>`);

  const metaLine = metaParts.map((p, i) =>
    i === 0 ? p : `<span class="meta-sep">·</span>${p}`
  ).join("");

  // Body
  const paras    = (item.thesis_relevance || "").split(/\n\n+/).filter(p => p.trim());
  const bodyHtml = paras.map((p, i) =>
    `<p${i === paras.length - 1 ? ' class="thesis"' : ""}>${p}</p>`
  ).join("");
  const link = item.url
    ? `<a class="read-link" href="${item.url}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Read source →</a>`
    : "";

  return `
    <article onclick="toggleCard('${id}')">
      <div class="card-top-line">
        <span class="card-imp imp-${imp}">${{ALTA:"Alta",MEDIA:"Media",BAJA:"Baja"}[imp]||imp}</span>${metaLine}
      </div>
      <h2 class="card-title">${item.title || "(no title)"}</h2>
      <div class="card-byline">${byline}</div>
      <div class="card-body${isOpen ? " open" : ""}" id="${id}">
        ${bodyHtml}
        ${link}
      </div>
    </article>`;
}

function toggleCard(id) {
  const el = document.getElementById(id);
  if (!el) return;
  if (expandedIds.has(id)) { expandedIds.delete(id); el.classList.remove("open"); }
  else                     { expandedIds.add(id);    el.classList.add("open");    }
}

function renderMain(html) { document.getElementById("main").innerHTML = html; }

// ── Pagination ───────────────────────────────────────────────
function renderPagination() {
  const el = document.getElementById("pagination");
  if (state.total_pages <= 1) { el.innerHTML = ""; return; }

  const pages = [];
  for (let i = 1; i <= state.total_pages; i++) {
    if (i === 1 || i === state.total_pages || Math.abs(i - state.page) <= 2) pages.push(i);
  }

  let html = `<button class="btn-page" ${!state.has_prev?"disabled":""} onclick="goPage(${state.page-1})">← Prev</button>`;
  let last = 0;
  for (const p of pages) {
    if (last && p - last > 1) html += `<span class="ellipsis">…</span>`;
    html += `<button class="btn-page${p===state.page?" current":""}" onclick="goPage(${p})">${p}</button>`;
    last = p;
  }
  html += `<button class="btn-page" ${!state.has_next?"disabled":""} onclick="goPage(${state.page+1})">Next →</button>`;
  el.innerHTML = html;
}

function setRefreshBtn(loading) {
  const btn = document.getElementById("btnRefresh");
  btn.textContent = loading ? "↻ Loading…" : "↻ Refresh";
  btn.disabled = loading;
}

// ── Dates ────────────────────────────────────────────────────
function formatDate(d) {
  if (!d) return "";
  const dt = new Date(d);
  if (isNaN(dt)) return String(d);
  return dt.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" });
}

// ── Export ───────────────────────────────────────────────────
function exportMarkdown() {
  if (!state.rows.length) { alert("Nothing to export."); return; }
  const lines = ["# Thesis Monitor Export", `_${new Date().toLocaleDateString()}_`, ""];
  for (const item of state.rows) {
    lines.push(`## ${item.title || "(no title)"}`);
    lines.push(`**${item.importance}** · ${item.source || ""} · ${formatDate(item.date_published)}`);
    if (item.scholar)      lines.push(`Scholar: ${item.scholar}`);
    if (item.capa)         lines.push(`Capa: ${item.capa}`);
    if (item.action_tag)   lines.push(`Action: ${item.action_tag}`);
    if (item.content_type) lines.push(`Type: ${item.content_type}`);
    if (item.tier)         lines.push(`Tier: T${item.tier}`);
    lines.push("");
    if (item.thesis_relevance) lines.push(item.thesis_relevance);
    if (item.url)          lines.push(`\n[Source](${item.url})`);
    lines.push("\n---\n");
  }
  const text = lines.join("\n");
  navigator.clipboard.writeText(text)
    .then(() => alert("Copied ✓"))
    .catch(() => {
      const ta = document.createElement("textarea");
      ta.value = text; document.body.appendChild(ta);
      ta.select(); document.execCommand("copy");
      document.body.removeChild(ta); alert("Copied ✓");
    });
}

// ── Init ────────────────────────────────────────────────────
fetchData();
</script>
</body>
</html>
