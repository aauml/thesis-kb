<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thesis Knowledge Base</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #FAFAF8;
    color: #111;
    min-height: 100vh;
  }
  a { color: #1E40AF; text-decoration: none; }
  a:hover { text-decoration: underline; }
  button { font-family: inherit; cursor: pointer; }
  .container { max-width: 820px; margin: 0 auto; padding: 0 24px; }

  /* ── Header ── */
  header { border-bottom: 2px solid #111; padding: 28px 0 16px; }
  .header-top {
    display: flex; justify-content: space-between; align-items: baseline;
    margin-bottom: 2px;
  }
  h1 { font-family: Georgia, serif; font-size: 28px; font-weight: 300; letter-spacing: -0.5px; }
  .header-sub { font-family: Georgia, serif; font-size: 13px; color: #6B7280; font-style: italic; margin-bottom: 12px; }
  .header-stats { display: flex; gap: 16px; font-size: 12px; color: #6B7280; flex-wrap: wrap; align-items: center; }
  .header-stats strong { color: #111; }
  .refresh-area { display: flex; gap: 12px; align-items: baseline; }
  .last-fetch { font-size: 11px; color: #9CA3AF; }
  .btn-refresh { font-size: 12px; font-weight: 600; color: #1E40AF; background: none; border: none; padding: 0; }
  .btn-refresh:disabled { color: #9CA3AF; cursor: default; }

  /* ── Controls row ── */
  .controls {
    padding: 12px 0 0;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
  }

  /* Importance toggles */
  .btn-imp {
    padding: 4px 10px; font-size: 11px; font-weight: 700;
    letter-spacing: 0.05em; text-transform: uppercase;
    border: 1px solid #E5E7EB; border-radius: 3px;
    background: #fff; color: #6B7280; white-space: nowrap;
  }
  .btn-imp.active-ALTA  { background: #DC2626; border-color: #DC2626; color: #fff; }
  .btn-imp.active-MEDIA { background: #D97706; border-color: #D97706; color: #fff; }
  .btn-imp.active-BAJA  { background: #9CA3AF; border-color: #9CA3AF; color: #fff; }

  /* Capa toggles */
  .btn-capa {
    padding: 4px 10px; font-size: 11px; font-weight: 600;
    letter-spacing: 0.03em;
    border: 1px solid #E5E7EB; border-radius: 3px;
    background: #fff; color: #6B7280; white-space: nowrap;
  }
  .btn-capa.active-teorica    { background: #1E40AF; border-color: #1E40AF; color: #fff; }
  .btn-capa.active-analitica  { background: #166534; border-color: #166534; color: #fff; }
  .btn-capa.active-evaluativa { background: #6B21A8; border-color: #6B21A8; color: #fff; }

  /* Divider between groups */
  .ctrl-sep { width: 1px; height: 20px; background: #E5E7EB; margin: 0 2px; flex-shrink: 0; }

  /* Dropdowns */
  select {
    padding: 4px 6px; font-size: 12px;
    border: 1px solid #E5E7EB; border-radius: 3px;
    background: #fff; color: #374151;
    font-family: inherit; cursor: pointer;
    height: 28px;
  }
  select:focus { outline: none; border-color: #93C5FD; }

  /* Search */
  .search-wrap { position: relative; display: flex; align-items: center; }
  .search-wrap input[type=text] {
    width: 200px; height: 28px;
    padding: 0 26px 0 9px; font-size: 12px;
    border: 1px solid #E5E7EB; border-radius: 3px;
    background: #fff; outline: none; font-family: inherit;
  }
  .search-wrap input[type=text]:focus { border-color: #93C5FD; }
  .btn-clear-x {
    position: absolute; right: 6px;
    background: none; border: none;
    font-size: 12px; color: #9CA3AF;
    line-height: 1; padding: 0; cursor: pointer; display: none;
  }
  .btn-search {
    height: 28px; padding: 0 12px; font-size: 12px; font-weight: 500;
    border: 1px solid #1E40AF; border-radius: 3px;
    background: #1E40AF; color: #fff;
  }

  /* Clear all */
  .btn-clear-all {
    background: none; border: 1px solid #E5E7EB; border-radius: 3px;
    font-size: 11px; color: #9CA3AF;
    padding: 3px 8px; height: 28px;
    display: none;
  }
  .btn-clear-all:hover { border-color: #DC2626; color: #DC2626; }

  /* Filter count + export row */
  .meta-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 0 0; font-size: 11px; color: #9CA3AF;
    flex-wrap: wrap; gap: 8px;
  }
  .btn-export {
    font-size: 11px; color: #6B7280; background: none;
    border: 1px solid #E5E7EB; border-radius: 3px; padding: 3px 10px;
  }
  .btn-export:hover { border-color: #93C5FD; color: #1E40AF; }

  /* ── Cards ── */
  main { padding: 0 0 80px; }
  article {
    border-bottom: 1px solid #E5E7EB;
    padding: 16px 0;
    cursor: pointer;
  }
  article:hover { background: #F9FAFB; margin: 0 -8px; padding-left: 8px; padding-right: 8px; }

  /* Single meta line */
  .card-meta {
    display: flex; flex-wrap: wrap; align-items: center;
    gap: 0; margin-bottom: 6px; font-size: 11px; line-height: 1.8;
  }
  .card-imp {
    display: inline-flex; align-items: center;
    padding: 2px 8px; border-radius: 3px;
    font-size: 10px; font-weight: 700;
    letter-spacing: 0.07em; text-transform: uppercase;
    line-height: 1.6; margin-right: 6px; flex-shrink: 0;
  }
  .imp-ALTA  { background: #DC2626; color: #fff; }
  .imp-MEDIA { background: #D97706; color: #fff; }
  .imp-BAJA  { background: #9CA3AF; color: #fff; }

  .meta-sep { color: #D1D5DB; padding: 0 5px; user-select: none; }

  .meta-capa-teorica    { color: #1E40AF; font-weight: 600; }
  .meta-capa-analitica  { color: #166534; font-weight: 600; }
  .meta-capa-evaluativa { color: #6B21A8; font-weight: 600; }
  .meta-capa-detail     { color: #6B7280; }
  .meta-evaluativa      { color: #6B21A8; font-style: italic; }
  .meta-action          { font-weight: 600; color: #D97706; }
  .meta-type            { color: #9CA3AF; }

  .card-title {
    font-family: Georgia, serif;
    font-size: 18px; font-weight: 400; line-height: 1.35;
    margin: 0 0 4px; color: #111;
  }
  .card-byline {
    font-size: 11px; color: #9CA3AF;
    display: flex; gap: 0; flex-wrap: wrap; align-items: center;
  }
  .card-byline .scholar { color: #6B7280; font-weight: 500; }
  .card-byline .lang { text-transform: uppercase; font-weight: 600; font-size: 10px; }

  /* Expandable body */
  .card-body {
    margin-top: 12px; padding-left: 12px;
    border-left: 2px solid #E5E7EB;
    display: none;
  }
  .card-body.open { display: block; }
  .card-body p { font-size: 13px; line-height: 1.7; margin: 0 0 8px; color: #4B5563; }
  .card-body p.thesis { color: #111; font-weight: 500; }
  .card-body .read-link { font-size: 12px; font-weight: 500; }

  /* ── Pagination ── */
  .pagination {
    display: flex; gap: 6px; justify-content: center;
    padding: 28px 0 0; align-items: center; flex-wrap: wrap;
  }
  .btn-page {
    padding: 5px 10px; font-size: 12px;
    border: 1px solid #E5E7EB; border-radius: 3px;
    background: #fff; color: #374151;
  }
  .btn-page:hover:not(:disabled) { border-color: #93C5FD; }
  .btn-page.current { background: #1E40AF; border-color: #1E40AF; color: #fff; font-weight: 600; cursor: default; }
  .btn-page:disabled { color: #D1D5DB; background: #F9FAFB; cursor: default; }
  .ellipsis { font-size: 12px; color: #9CA3AF; padding: 0 2px; }

  /* ── States ── */
  .state-msg { text-align: center; padding: 60px 0; color: #9CA3AF; font-size: 14px; }
  .error-box {
    margin-top: 24px; padding: 14px 16px;
    background: #FEF2F2; border: 1px solid #FECACA;
    border-radius: 6px; font-size: 13px; color: #991B1B; line-height: 1.6;
  }
</style>
</head>
<body>
<div class="container">

  <header>
    <div class="header-top">
      <h1>Thesis Knowledge Base</h1>
      <div class="refresh-area">
        <span class="last-fetch" id="lastFetch"></span>
        <button class="btn-refresh" id="btnRefresh" onclick="refresh()">↻ Refresh</button>
      </div>
    </div>
    <p class="header-sub">EU AI Act ↔ NIST AI RMF Interoperability</p>
    <div class="header-stats" id="headerStats"><span>Loading…</span></div>
  </header>

  <!-- Single controls row -->
  <div class="controls">
    <!-- Importance -->
    <button class="btn-imp" id="btn-ALTA"  onclick="toggleImp('ALTA')">Alta</button>
    <button class="btn-imp" id="btn-MEDIA" onclick="toggleImp('MEDIA')">Media</button>
    <button class="btn-imp" id="btn-BAJA"  onclick="toggleImp('BAJA')">Baja</button>

    <div class="ctrl-sep"></div>

    <!-- Capa -->
    <button class="btn-capa" id="btn-teorica"    onclick="toggleCapa('teorica')">Teórica</button>
    <button class="btn-capa" id="btn-analitica"  onclick="toggleCapa('analitica')">Analítica</button>
    <button class="btn-capa" id="btn-evaluativa" onclick="toggleCapa('evaluativa')">Evaluativa</button>

    <div class="ctrl-sep"></div>

    <!-- Capa detail -->
    <select id="selCapaDetail" onchange="applyDropdown()">
      <option value="">Subcapa</option>
      <optgroup label="Teórica">
        <option value="gobernanza de ia comparada">Gobernanza comparada</option>
        <option value="metodología de derecho comparado">Derecho comparado</option>
        <option value="derecho procesal y prueba electrónica">Prueba electrónica</option>
        <option value="contestabilidad algorítmica">Contestabilidad</option>
      </optgroup>
      <optgroup label="Analítica">
        <option value="gestión de riesgos">Art. 9 · Riesgos</option>
        <option value="gobernanza de datos">Art. 10 · Datos</option>
        <option value="documentación técnica">Art. 11 · Documentación</option>
        <option value="registro de actividades">Art. 12 · Registro</option>
        <option value="transparencia">Art. 13 · Transparencia</option>
        <option value="supervisión humana">Art. 14 · Supervisión</option>
        <option value="robustez">Art. 15 · Robustez</option>
      </optgroup>
      <optgroup label="Evaluativa">
        <option value="contestabilidad">Evaluativa · Contestabilidad</option>
        <option value="accountability">Evaluativa · Accountability</option>
        <option value="equidad">Evaluativa · Equidad</option>
        <option value="explicabilidad">Evaluativa · Explicabilidad</option>
      </optgroup>
    </select>

    <!-- Evaluativa criteria -->
    <select id="selEvaluativa" onchange="applyDropdown()">
      <option value="">Criterio eval.</option>
      <option value="contestabilidad">Contestabilidad</option>
      <option value="accountability">Accountability</option>
      <option value="equidad">Equidad / No discriminación</option>
      <option value="explicabilidad">Explicabilidad</option>
    </select>

    <!-- Content type -->
    <select id="selType" onchange="applyDropdown()">
      <option value="">Tipo</option>
      <option value="article">Article</option>
      <option value="book">Book</option>
      <option value="report">Report</option>
      <option value="regulation">Regulation</option>
      <option value="thesis">Thesis</option>
      <option value="other">Other</option>
    </select>

    <!-- Sort -->
    <select id="selSort" onchange="applySort()">
      <option value="found-desc">Newest</option>
      <option value="found-asc">Oldest</option>
      <option value="date-desc">Pub. ↓</option>
      <option value="date-asc">Pub. ↑</option>
      <option value="importance">Importance</option>
    </select>

    <div class="ctrl-sep"></div>

    <!-- Search -->
    <div class="search-wrap">
      <input type="text" id="searchInput" placeholder="Search…"
             onkeydown="if(event.key==='Enter')submitSearch()"
             oninput="updateXBtn()" />
      <button class="btn-clear-x" id="btnClearX" onclick="clearSearch()" title="Clear">✕</button>
    </div>
    <button class="btn-search" onclick="submitSearch()">Go</button>

    <button class="btn-clear-all" id="btnClearAll" onclick="clearAllFilters()">✕ Clear</button>
  </div>

  <div class="meta-row">
    <span id="filterCount"></span>
    <button class="btn-export" onclick="exportMarkdown()">⬇ Copy as Markdown</button>
  </div>

  <main id="main"><div class="state-msg">Loading…</div></main>
  <div class="pagination" id="pagination"></div>

</div>

<script>
const API_URL    = "https://script.google.com/macros/s/AKfycbzk2vhu-qcKFBPqEImKGEZKSitpVZv1IQQEv5ZzG7pNfo-iPUWfvSoLWWnkoc8d8PQQ/exec";
const PAGE_LIMIT = 50;

let state = {
  page: 1, search: "", importance: "", capa: "", sort: "found-desc",
  rows: [], total: 0, total_pages: 1, has_next: false, has_prev: false,
  loading: false, lastFetch: null,
};
let expandedIds = new Set();

// ── URL builder ──────────────────────────────────────────────────────────────
function buildUrl() {
  let url = API_URL + "?action=getPage"
    + "&page=" + state.page
    + "&limit=" + PAGE_LIMIT
    + "&sort=" + encodeURIComponent(state.sort);
  if (state.importance) url += "&importance=" + encodeURIComponent(state.importance);
  if (state.capa)       url += "&capa="       + encodeURIComponent(state.capa);
  // capa_detail, evaluativa_criteria, content_type go into search for now
  // (backend supports them in haystack fulltext search)
  const extra = buildExtraSearch();
  const combined = [state.search, extra].filter(Boolean).join(" ");
  if (combined) url += "&search=" + encodeURIComponent(combined);
  return url;
}

function buildExtraSearch() {
  const parts = [];
  const cd = document.getElementById("selCapaDetail").value;
  const ev = document.getElementById("selEvaluativa").value;
  const tp = document.getElementById("selType").value;
  if (cd) parts.push(cd);
  if (ev) parts.push(ev);
  if (tp) parts.push(tp);
  return parts.join(" ");
}

// ── JSONP ────────────────────────────────────────────────────────────────────
function jsonp(url) {
  return new Promise((resolve, reject) => {
    const cbName = "_cb_" + Math.random().toString(36).slice(2);
    const timer = setTimeout(() => { delete window[cbName]; reject(new Error("Timeout")); }, 25000);
    window[cbName] = data => { clearTimeout(timer); delete window[cbName]; resolve(data); };
    const s = document.createElement("script");
    s.src = url + "&callback=" + cbName;
    s.onerror = () => { clearTimeout(timer); delete window[cbName]; reject(new Error("Network error")); };
    document.head.appendChild(s);
  });
}

// ── Fetch ────────────────────────────────────────────────────────────────────
async function fetchData() {
  if (state.loading) return;
  state.loading = true;
  setRefreshBtn(true);
  renderMain('<div class="state-msg">Loading…</div>');
  document.getElementById("pagination").innerHTML = "";
  try {
    const data = await jsonp(buildUrl());
    if (data.error) throw new Error(data.error);
    state.total       = data.total;
    state.total_pages = data.total_pages;
    state.has_next    = data.has_next;
    state.has_prev    = data.has_prev;
    state.page        = data.page || state.page;
    state.lastFetch   = new Date();
    state.rows        = data.rows || [];
    renderHeader(data.stats || null);
    renderFlat();
    renderPagination();
  } catch(e) {
    renderMain(`<div class="error-box"><strong>Could not load data.</strong> ${e.message}</div>`);
  }
  state.loading = false;
  setRefreshBtn(false);
  if (state.lastFetch)
    document.getElementById("lastFetch").textContent =
      state.lastFetch.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
}

function refresh() { fetchData(); }

// ── Filters ──────────────────────────────────────────────────────────────────
function toggleImp(imp) {
  ["ALTA","MEDIA","BAJA"].forEach(i => {
    const btn = document.getElementById("btn-" + i);
    const wasActive = btn.classList.contains("active-" + i);
    btn.className = "btn-imp" + (i === imp && !wasActive ? " active-" + i : "");
  });
  state.importance = document.getElementById("btn-ALTA").classList.contains("active-ALTA")   ? "ALTA"
                   : document.getElementById("btn-MEDIA").classList.contains("active-MEDIA") ? "MEDIA"
                   : document.getElementById("btn-BAJA").classList.contains("active-BAJA")   ? "BAJA" : "";
  state.page = 1; updateClearBtn(); fetchData();
}

function toggleCapa(capa) {
  ["teorica","analitica","evaluativa"].forEach(c => {
    const btn = document.getElementById("btn-" + c);
    const wasActive = btn.classList.contains("active-" + c);
    btn.className = "btn-capa" + (c === capa && !wasActive ? " active-" + c : "");
  });
  state.capa = document.getElementById("btn-teorica").classList.contains("active-teorica")       ? "teórica"
             : document.getElementById("btn-analitica").classList.contains("active-analitica")   ? "analítica"
             : document.getElementById("btn-evaluativa").classList.contains("active-evaluativa") ? "evaluativa" : "";
  state.page = 1; updateClearBtn(); fetchData();
}

function applyDropdown() { state.page = 1; updateClearBtn(); fetchData(); }
function applySort()     { state.sort = document.getElementById("selSort").value; state.page = 1; fetchData(); }

function submitSearch() {
  state.search = document.getElementById("searchInput").value.trim();
  state.page = 1; updateXBtn(); updateClearBtn(); fetchData();
}

function clearSearch() {
  document.getElementById("searchInput").value = "";
  state.search = ""; state.page = 1; updateXBtn(); updateClearBtn(); fetchData();
}

function clearAllFilters() {
  document.getElementById("searchInput").value = "";
  document.getElementById("selSort").value = "found-desc";
  document.getElementById("selCapaDetail").value = "";
  document.getElementById("selEvaluativa").value = "";
  document.getElementById("selType").value = "";
  ["ALTA","MEDIA","BAJA"].forEach(i => document.getElementById("btn-" + i).className = "btn-imp");
  ["teorica","analitica","evaluativa"].forEach(c => document.getElementById("btn-" + c).className = "btn-capa");
  state.search = ""; state.importance = ""; state.capa = "";
  state.sort = "found-desc"; state.page = 1;
  updateXBtn(); updateClearBtn(); fetchData();
}

function updateXBtn() {
  const val = document.getElementById("searchInput").value;
  document.getElementById("btnClearX").style.display = val ? "block" : "none";
}

function updateClearBtn() {
  const cd = document.getElementById("selCapaDetail").value;
  const ev = document.getElementById("selEvaluativa").value;
  const tp = document.getElementById("selType").value;
  const active = state.importance || state.capa || state.search || cd || ev || tp;
  document.getElementById("btnClearAll").style.display = active ? "inline" : "none";
}

function goPage(p) { state.page = p; fetchData(); }

// ── Render ───────────────────────────────────────────────────────────────────
function renderHeader(stats) {
  const el = document.getElementById("headerStats");
  const hasFilter = state.importance || state.capa || state.search
    || document.getElementById("selCapaDetail").value
    || document.getElementById("selEvaluativa").value
    || document.getElementById("selType").value;
  if (stats) {
    el.innerHTML = `
      <span><strong>${stats.total_all}</strong> sources</span>
      <span style="color:#DC2626;font-weight:700">${stats.alta} Alta</span>
      <span style="color:#D97706;font-weight:700">${stats.media} Media</span>
      <span style="color:#9CA3AF;font-weight:700">${stats.baja} Baja</span>
      ${hasFilter ? `<span>· <strong>${state.total}</strong> matching</span>` : ""}
    `;
  } else {
    el.innerHTML = `<span><strong>${state.total}</strong> ${hasFilter ? "matching" : "total"} sources</span>`;
  }
  document.getElementById("filterCount").textContent = state.total_pages > 1
    ? `Page ${state.page} of ${state.total_pages} · ${state.total} items` : `${state.total} items`;
}

function renderFlat() {
  if (!state.rows.length) { renderMain('<div class="state-msg">No results.</div>'); return; }
  renderMain(state.rows.map((item, i) => renderCard(item, "c-" + state.page + "-" + i)).join(""));
}

// ── Card ─────────────────────────────────────────────────────────────────────
function renderCard(item, id) {
  const imp    = item.importance || "BAJA";
  const isOpen = expandedIds.has(id);

  // ── Build single meta line ──────────────────────────────────────────────
  const metaParts = [];

  // Capa label
  const capaRaw = (item.capa || "").toLowerCase();
  const capaClass = capaRaw.includes("teór") || capaRaw.includes("teor") ? "meta-capa-teorica"
                  : capaRaw.includes("analí") || capaRaw.includes("anali") ? "meta-capa-analitica"
                  : capaRaw.includes("eval") ? "meta-capa-evaluativa" : "";
  const capaLabel = capaRaw.includes("teór") || capaRaw.includes("teor") ? "Teórica"
                  : capaRaw.includes("analí") || capaRaw.includes("anali") ? "Analítica"
                  : capaRaw.includes("eval") ? "Evaluativa"
                  : item.capa || "";
  if (capaLabel) metaParts.push(`<span class="${capaClass}">${capaLabel}</span>`);

  // Capa detail
  if (item.capa_detail) metaParts.push(`<span class="meta-capa-detail">${item.capa_detail}</span>`);

  // Evaluativa criteria
  if (item.evaluativa_criteria) metaParts.push(`<span class="meta-evaluativa">${item.evaluativa_criteria}</span>`);

  // Action tag
  const ACT = { REFERENCE: "Reference", CONTEXT: "Context", "FOLLOW-UP": "Follow-up", URGENT: "Urgent" };
  const act = item.action_tag || "";
  if (act) metaParts.push(`<span class="meta-action">${ACT[act] || act}</span>`);

  // Content type
  if (item.content_type) metaParts.push(`<span class="meta-type">${item.content_type}</span>`);

  const metaLine = metaParts.map((p, i) =>
    i === 0 ? p : `<span class="meta-sep">·</span>${p}`
  ).join("");

  // ── Byline ──────────────────────────────────────────────────────────────
  const bylineParts = [
    item.source || "",
    item.date_published ? formatDate(item.date_published) : "",
    item.scholar ? `<span class="scholar">${item.scholar}</span>` : "",
    item.language && item.language !== "en" ? `<span class="lang">${item.language}</span>` : "",
  ].filter(Boolean);
  const byline = bylineParts.join('<span class="meta-sep">·</span>');

  // ── Body ─────────────────────────────────────────────────────────────────
  const paras = (item.thesis_relevance || "").split(/\n\n+/).filter(p => p.trim());
  const bodyHtml = paras.map((p, i) =>
    `<p${i === paras.length - 1 ? ' class="thesis"' : ""}>${p}</p>`
  ).join("");
  const link = item.url
    ? `<a class="read-link" href="${item.url}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Read source →</a>`
    : "";

  return `
    <article onclick="toggleCard('${id}')">
      <div class="card-meta">
        <span class="card-imp imp-${imp}">${{ALTA:"ALTA",MEDIA:"MEDIA",BAJA:"BAJA"}[imp]||imp}</span>${metaLine}
      </div>
      <h2 class="card-title">${item.title || "(no title)"}</h2>
      <div class="card-byline">${byline}</div>
      <div class="card-body${isOpen ? " open" : ""}" id="${id}">
        ${bodyHtml}
        ${link}
      </div>
    </article>`;
}

function toggleCard(id) {
  const el = document.getElementById(id);
  if (!el) return;
  if (expandedIds.has(id)) { expandedIds.delete(id); el.classList.remove("open"); }
  else                     { expandedIds.add(id);    el.classList.add("open");    }
}

function renderMain(html) { document.getElementById("main").innerHTML = html; }

// ── Pagination ───────────────────────────────────────────────────────────────
function renderPagination() {
  const el = document.getElementById("pagination");
  if (state.total_pages <= 1) { el.innerHTML = ""; return; }
  const pages = [];
  for (let i = 1; i <= state.total_pages; i++) {
    if (i === 1 || i === state.total_pages || Math.abs(i - state.page) <= 2) pages.push(i);
  }
  let html = `<button class="btn-page" ${!state.has_prev?"disabled":""} onclick="goPage(${state.page-1})">← Prev</button>`;
  let last = 0;
  for (const p of pages) {
    if (last && p - last > 1) html += `<span class="ellipsis">…</span>`;
    html += `<button class="btn-page${p===state.page?" current":""}" onclick="goPage(${p})">${p}</button>`;
    last = p;
  }
  html += `<button class="btn-page" ${!state.has_next?"disabled":""} onclick="goPage(${state.page+1})">Next →</button>`;
  el.innerHTML = html;
}

function setRefreshBtn(loading) {
  const btn = document.getElementById("btnRefresh");
  btn.textContent = loading ? "↻ …" : "↻ Refresh";
  btn.disabled = loading;
}

function formatDate(d) {
  if (!d) return "";
  const dt = new Date(d);
  if (isNaN(dt)) return String(d);
  return dt.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" });
}

function exportMarkdown() {
  if (!state.rows.length) { alert("Nothing to export."); return; }
  const lines = ["# Thesis Knowledge Base Export", `_${new Date().toLocaleDateString()}_`, ""];
  for (const item of state.rows) {
    lines.push(`## ${item.title || "(no title)"}`);
    lines.push(`**${item.importance}** · ${item.capa || ""} · ${item.capa_detail || ""} · ${item.evaluativa_criteria || ""}`);
    lines.push(`${item.source || ""} · ${formatDate(item.date_published)} · ${item.content_type || ""}`);
    if (item.scholar) lines.push(`Scholar: ${item.scholar}`);
    lines.push("");
    if (item.thesis_relevance) lines.push(item.thesis_relevance);
    if (item.url) lines.push(`\n[Source](${item.url})`);
    lines.push("\n---\n");
  }
  const text = lines.join("\n");
  navigator.clipboard.writeText(text)
    .then(() => alert("Copied ✓"))
    .catch(() => {
      const ta = document.createElement("textarea");
      ta.value = text; document.body.appendChild(ta);
      ta.select(); document.execCommand("copy");
      document.body.removeChild(ta); alert("Copied ✓");
    });
}

fetchData();
</script>
</body>
</html>
