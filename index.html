<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thesis Knowledge Base</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #FAFAF8;
    color: #111;
    min-height: 100vh;
  }
  a { color: #1E40AF; text-decoration: none; }
  a:hover { text-decoration: underline; }
  button { font-family: inherit; cursor: pointer; }
  .container { max-width: 820px; margin: 0 auto; padding: 0 16px; }

  /* ── Header ── */
  header { border-bottom: 2px solid #111; padding: 20px 0 14px; }
  .header-top {
    display: flex; justify-content: space-between; align-items: baseline;
    margin-bottom: 2px;
  }
  h1 { font-family: Georgia, serif; font-size: 24px; font-weight: 300; letter-spacing: -0.5px; }
  .header-sub { font-family: Georgia, serif; font-size: 12px; color: #6B7280; font-style: italic; margin-bottom: 10px; }
  .header-stats { display: flex; gap: 12px; font-size: 12px; color: #6B7280; flex-wrap: wrap; align-items: center; }
  .header-stats strong { color: #111; }
  .refresh-area { display: flex; gap: 10px; align-items: baseline; flex-shrink: 0; }
  .last-fetch { font-size: 11px; color: #9CA3AF; }
  .btn-refresh { font-size: 12px; font-weight: 600; color: #1E40AF; background: none; border: none; padding: 0; white-space: nowrap; }
  .btn-refresh:disabled { color: #9CA3AF; cursor: default; }

  /* ── Controls ── */
  .controls-section { padding-top: 10px; }

  /* Row 1: importance toggles */
  .controls-row1 {
    display: flex; flex-wrap: wrap; gap: 5px; align-items: center;
    margin-bottom: 6px;
  }

  /* Row 2: capa toggles */
  .controls-row2 {
    display: flex; flex-wrap: wrap; gap: 5px; align-items: center;
    margin-bottom: 6px;
  }

  /* Row 3: dropdowns + search */
  .controls-row3 {
    display: flex; flex-wrap: wrap; gap: 5px; align-items: center;
    padding-bottom: 4px;
  }

  .ctrl-sep { width: 1px; height: 20px; background: #E5E7EB; margin: 0 1px; flex-shrink: 0; }

  /* ── Importance toggles ── */
  .btn-imp {
    padding: 5px 11px; font-size: 11px; font-weight: 700;
    letter-spacing: 0.05em; text-transform: uppercase;
    border: 1px solid #E5E7EB; border-radius: 3px;
    background: #fff; color: #6B7280; white-space: nowrap;
    min-height: 30px;
    display: inline-flex; align-items: center; gap: 5px;
  }
  .btn-imp .btn-count {
    font-size: 9px; font-weight: 600;
    color: #9CA3AF;
    padding: 0; line-height: 1.4;
  }
  .btn-imp.active-ALTA  { background: #DC2626; border-color: #DC2626; color: #fff; }
  .btn-imp.active-MEDIA { background: #D97706; border-color: #D97706; color: #fff; }
  .btn-imp.active-BAJA  { background: #9CA3AF; border-color: #9CA3AF; color: #fff; }
  .btn-imp.active-ALTA  .btn-count,
  .btn-imp.active-MEDIA .btn-count,
  .btn-imp.active-BAJA  .btn-count { color: rgba(255,255,255,0.75); }

  /* ── Star filter button ── */
  .btn-star-filter {
    padding: 5px 10px; font-size: 13px; font-weight: 700;
    border: 1px solid #E5E7EB; border-radius: 3px;
    background: #fff; color: #D1D5DB; white-space: nowrap;
    min-height: 30px;
    display: inline-flex; align-items: center;
    line-height: 1;
  }
  .btn-star-filter.active { background: #FFFBEB; border-color: #F59E0B; color: #F59E0B; }

  /* ── Capa toggles ── */
  .btn-capa {
    padding: 5px 11px; font-size: 11px; font-weight: 600;
    letter-spacing: 0.02em;
    border: 1px solid #E5E7EB; border-radius: 3px;
    background: #fff; color: #6B7280; white-space: nowrap;
    min-height: 30px;
    display: inline-flex; align-items: center; gap: 5px;
  }
  .btn-capa.active-teorica    { background: #1E40AF; border-color: #1E40AF; color: #fff; }
  .btn-capa.active-analitica  { background: #166534; border-color: #166534; color: #fff; }
  .btn-capa.active-evaluativa { background: #6B21A8; border-color: #6B21A8; color: #fff; }
  .btn-capa.active-metodologica { background: #0E7490; border-color: #0E7490; color: #fff; }

  /* ── Dropdowns ── */
  select {
    padding: 0 6px; font-size: 12px;
    border: 1px solid #E5E7EB; border-radius: 3px;
    background: #fff; color: #374151;
    font-family: inherit; cursor: pointer;
    height: 30px;
    max-width: 160px;
  }
  select:focus { outline: none; border-color: #93C5FD; }
  select.filter-active { border-color: #6B7280; color: #111; font-weight: 600; }

  /* ── Search ── */
  .search-wrap { position: relative; display: flex; align-items: center; flex: 1; min-width: 120px; max-width: 220px; }
  .search-wrap input[type=text] {
    width: 100%; height: 30px;
    padding: 0 26px 0 9px; font-size: 12px;
    border: 1px solid #E5E7EB; border-radius: 3px;
    background: #fff; outline: none; font-family: inherit;
  }
  .search-wrap input[type=text]:focus { border-color: #93C5FD; }
  .btn-clear-x {
    position: absolute; right: 6px;
    background: none; border: none;
    font-size: 12px; color: #9CA3AF;
    line-height: 1; padding: 0; cursor: pointer; display: none;
  }
  .btn-search {
    height: 30px; padding: 0 12px; font-size: 12px; font-weight: 500;
    border: 1px solid #1E40AF; border-radius: 3px;
    background: #1E40AF; color: #fff; white-space: nowrap;
  }

  /* ── Clear all ── */
  .btn-clear-all {
    background: none; border: 1px solid #E5E7EB; border-radius: 3px;
    font-size: 11px; color: #9CA3AF;
    padding: 0 8px; height: 30px;
    display: none; white-space: nowrap;
  }
  .btn-clear-all:hover { border-color: #DC2626; color: #DC2626; }

  /* ── Filter count + export row ── */
  .meta-row {
    display: flex; align-items: center; justify-content: space-between;
    padding: 7px 0 0; font-size: 11px; color: #9CA3AF;
    flex-wrap: wrap; gap: 6px;
  }
  .btn-export {
    font-size: 11px; color: #6B7280; background: none;
    border: 1px solid #E5E7EB; border-radius: 3px; padding: 3px 10px;
  }
  .btn-export:hover { border-color: #93C5FD; color: #1E40AF; }

  /* ── Cards ── */
  main { padding: 0 0 80px; }
  article {
    border-bottom: 1px solid #E5E7EB;
    padding: 14px 0;
    cursor: pointer;
    position: relative;
  }
  article:hover { background: #F9FAFB; margin: 0 -8px; padding-left: 8px; padding-right: 8px; }

  .card-meta {
    display: flex; flex-wrap: wrap; align-items: center;
    gap: 0; margin-bottom: 5px; font-size: 11px; line-height: 1.9;
  }
  .card-imp {
    display: inline-flex; align-items: center;
    padding: 2px 7px; border-radius: 3px;
    font-size: 10px; font-weight: 700;
    letter-spacing: 0.07em; text-transform: uppercase;
    line-height: 1.6; margin-right: 6px; flex-shrink: 0;
  }
  .imp-ALTA  { background: #DC2626; color: #fff; }
  .imp-MEDIA { background: #D97706; color: #fff; }
  .imp-BAJA  { background: #9CA3AF; color: #fff; }

  .meta-sep { color: #D1D5DB; padding: 0 4px; user-select: none; }

  .meta-capa-teorica      { color: #1E40AF; font-weight: 600; }
  .meta-capa-analitica    { color: #166534; font-weight: 600; }
  .meta-capa-evaluativa   { color: #6B21A8; font-weight: 600; }
  .meta-capa-metodologica { color: #0E7490; font-weight: 600; }
  .meta-capa-detail       { color: #6B7280; }
  .meta-evaluativa        { color: #6B21A8; font-style: italic; }
  .meta-action            { font-weight: 600; color: #D97706; }
  .meta-type              { color: #9CA3AF; }
  .meta-tier              { color: #9CA3AF; font-weight: 600; }

  /* ── Inline star button in meta line ── */
  .btn-star {
    background: none; border: none; padding: 0;
    font-size: 13px; line-height: 1;
    color: #D1D5DB;
    cursor: pointer;
    display: inline-flex; align-items: center;
    margin-right: 6px; flex-shrink: 0;
    transition: color 0.1s, transform 0.1s;
    user-select: none;
  }
  .btn-star:hover { color: #F59E0B; transform: scale(1.2); }
  .btn-star.starred { color: #F59E0B; }
  .btn-star.saving  { opacity: 0.4; pointer-events: none; }

  .card-title {
    font-family: Georgia, serif;
    font-size: 17px; font-weight: 400; line-height: 1.35;
    margin: 0 0 4px; color: #111;
  }
  .card-byline {
    font-size: 11px; color: #9CA3AF;
    display: flex; gap: 0; flex-wrap: wrap; align-items: center;
  }
  .card-byline .scholar { color: #6B7280; font-weight: 500; }
  .card-byline .lang { text-transform: uppercase; font-weight: 600; font-size: 10px; }

  .card-body {
    margin-top: 10px; padding-left: 12px;
    border-left: 2px solid #E5E7EB;
    display: none;
  }
  .card-body.open { display: block; }
  .card-body p { font-size: 13px; line-height: 1.7; margin: 0 0 8px; color: #4B5563; }
  .card-body p.thesis { color: #111; font-weight: 500; }
  .card-body .read-link { font-size: 12px; font-weight: 500; }

  /* ── Pagination ── */
  .pagination {
    display: flex; gap: 5px; justify-content: center;
    padding: 24px 0 0; align-items: center; flex-wrap: wrap;
  }
  .btn-page {
    padding: 6px 10px; font-size: 12px;
    border: 1px solid #E5E7EB; border-radius: 3px;
    background: #fff; color: #374151;
    min-height: 32px;
  }
  .btn-page:hover:not(:disabled) { border-color: #93C5FD; }
  .btn-page.current { background: #1E40AF; border-color: #1E40AF; color: #fff; font-weight: 600; cursor: default; }
  .btn-page:disabled { color: #D1D5DB; background: #F9FAFB; cursor: default; }
  .ellipsis { font-size: 12px; color: #9CA3AF; padding: 0 2px; }

  /* ── States ── */
  .state-msg { text-align: center; padding: 60px 0; color: #9CA3AF; font-size: 14px; }
  .error-box {
    margin-top: 24px; padding: 14px 16px;
    background: #FEF2F2; border: 1px solid #FECACA;
    border-radius: 6px; font-size: 13px; color: #991B1B; line-height: 1.6;
  }

  /* ── Mobile ── */
  @media (max-width: 480px) {
    h1 { font-size: 18px; }
    .last-fetch { display: none; }
    .controls-row-label { display: none; }

    .controls-row1,
    .controls-row2 { gap: 4px; flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 2px; }

    .btn-imp, .btn-capa {
      padding: 4px 8px; font-size: 10px;
      min-height: 28px; flex-shrink: 0;
    }
    .btn-imp .btn-count,
    .btn-capa .btn-count { display: none; }

    .ctrl-sep { display: none; }

    .controls-row3 { gap: 4px; }
    select { max-width: none; flex: 1 1 auto; min-width: 0; font-size: 11px; }
    .search-wrap { flex: 1 1 100%; max-width: none; }
    .btn-search { flex-shrink: 0; }

    .card-title { font-size: 15px; }
    .card-body p { font-size: 13px; }
  }

  /* ── Tablet / laptop ── */
  @media (min-width: 481px) and (max-width: 768px) {
    .container { padding: 0 14px; }
    .btn-imp, .btn-capa { padding: 5px 9px; font-size: 11px; }
    select { max-width: 130px; }
    .search-wrap { max-width: 180px; }
  }

  @media (min-width: 769px) {
    .controls-row3 { flex-wrap: nowrap; }
    .search-wrap { max-width: 200px; }
  }
</style>
</head>
<body>
<div class="container">

  <header>
    <div class="header-top">
      <h1>Thesis Knowledge Base</h1>
      <div class="refresh-area">
        <span class="last-fetch" id="lastFetch"></span>
        <button class="btn-refresh" id="btnRefresh" onclick="refresh()">↻ Refresh</button>
      </div>
    </div>
    <p class="header-sub">EU AI Act ↔ NIST AI RMF Interoperability</p>
    <div class="header-stats" id="headerStats"><span>Loading…</span></div>
  </header>

  <div class="controls-section">

    <!-- Row 1: Importance + Star filter -->
    <div class="controls-row1">
      <button class="btn-imp" id="btn-ALTA"  onclick="toggleImp('ALTA')">
        Alta<span class="btn-count" id="cnt-ALTA">—</span>
      </button>
      <button class="btn-imp" id="btn-MEDIA" onclick="toggleImp('MEDIA')">
        Media<span class="btn-count" id="cnt-MEDIA">—</span>
      </button>
      <button class="btn-imp" id="btn-BAJA"  onclick="toggleImp('BAJA')">
        Baja<span class="btn-count" id="cnt-BAJA">—</span>
      </button>
      <div class="ctrl-sep"></div>
      <button class="btn-star-filter" id="btnStarFilter" onclick="toggleStarFilter()" title="Show starred only">★</button>
    </div>

    <!-- Row 2: Capa -->
    <div class="controls-row2">
      <button class="btn-capa" id="btn-teorica"       onclick="toggleCapa('teorica')">Teórica</button>
      <button class="btn-capa" id="btn-analitica"     onclick="toggleCapa('analitica')">Analítica</button>
      <button class="btn-capa" id="btn-evaluativa"    onclick="toggleCapa('evaluativa')">Evaluativa</button>
      <button class="btn-capa" id="btn-metodologica"  onclick="toggleCapa('metodologica')">Metodológica</button>
    </div>

    <!-- Row 3: Dropdowns + search -->
    <div class="controls-row3">
      <select id="selCapaDetail" onchange="applyDropdown()">
        <!-- Options filled dynamically based on active capa -->
      </select>
      <select id="selEvaluativa" onchange="applyDropdown()">
        <option value="">Criterio</option>
        <option value="contestabilidad">Contestabilidad</option>
        <option value="accountability">Accountability</option>
        <option value="equidad">Equidad</option>
        <option value="explicabilidad">Explicabilidad</option>
      </select>
      <select id="selType" onchange="applyDropdown()">
        <option value="">Tipo</option>
        <option value="article">Article</option>
        <option value="book">Book</option>
        <option value="report">Report</option>
        <option value="regulation">Regulation</option>
        <option value="thesis">Thesis</option>
        <option value="other">Other</option>
      </select>
      <select id="selSort" onchange="applySort()">
        <option value="found-desc">Newest</option>
        <option value="found-asc">Oldest</option>
        <option value="date-desc">Pub. ↓</option>
        <option value="date-asc">Pub. ↑</option>
        <option value="importance">Importance</option>
      </select>
      <div class="search-wrap">
        <input type="text" id="searchInput" placeholder="Search…"
               onkeydown="if(event.key==='Enter')submitSearch()"
               oninput="updateXBtn()" />
        <button class="btn-clear-x" id="btnClearX" onclick="clearSearch()" title="Clear">✕</button>
      </div>
      <button class="btn-search" onclick="submitSearch()">Go</button>
      <button class="btn-clear-all" id="btnClearAll" onclick="clearAllFilters()">✕ Clear</button>
    </div>

  </div>

  <div class="meta-row">
    <span id="filterCount"></span>
    <button class="btn-export" onclick="exportMarkdown()">⬇ Copy as Markdown</button>
  </div>

  <main id="main"><div class="state-msg">Loading…</div></main>
  <div class="pagination" id="pagination"></div>

</div>

<script>
const API_URL    = "https://script.google.com/macros/s/AKfycbzk2vhu-qcKFBPqEImKGEZKSitpVZv1IQQEv5ZzG7pNfo-iPUWfvSoLWWnkoc8d8PQQ/exec";
const PAGE_LIMIT = 50;

const SUBCAPA_OPTIONS = {
  all: [
    { label: "— Subcapa —", value: "" },
    { group: "Teórica", options: [
      { label: "Gobernanza IA comparada",              value: "Gobernanza IA comparada" },
      { label: "Metodología derecho comparado",        value: "Metodología derecho comparado" },
      { label: "Contestabilidad algorítmica",          value: "Contestabilidad algorítmica" },
      { label: "Derecho procesal y prueba electrónica",value: "Derecho procesal y prueba electrónica" },
    ]},
    { group: "Analítica", options: [
      { label: "Art. 9 · MAP/MEASURE",   value: "Art. 9 ↔ MAP/MEASURE" },
      { label: "Art. 10 · MAP/GOVERN",   value: "Art. 10 ↔ MAP/GOVERN" },
      { label: "Art. 11 · GOVERN",       value: "Art. 11 ↔ GOVERN" },
      { label: "Art. 12 · MEASURE",      value: "Art. 12 ↔ MEASURE" },
      { label: "Art. 13 · GOVERN/MAP",   value: "Art. 13 ↔ GOVERN/MAP" },
      { label: "Art. 14 · GOVERN/MANAGE",value: "Art. 14 ↔ GOVERN/MANAGE" },
      { label: "Art. 15 · MEASURE/MANAGE",value: "Art. 15 ↔ MEASURE/MANAGE" },
    ]},
    { group: "Evaluativa", options: [
      { label: "Contestabilidad algorítmica",          value: "Contestabilidad algorítmica" },
      { label: "Derecho procesal y prueba electrónica",value: "Derecho procesal y prueba electrónica" },
    ]},
    { group: "Metodológica", options: [
      { label: "Gobernanza IA comparada",              value: "Gobernanza IA comparada" },
      { label: "Metodología derecho comparado",        value: "Metodología derecho comparado" },
      { label: "Contestabilidad algorítmica",          value: "Contestabilidad algorítmica" },
      { label: "Derecho procesal y prueba electrónica",value: "Derecho procesal y prueba electrónica" },
      { label: "Metodología de investigación",         value: "Metodología de investigación doctoral" },
    ]},
  ],
  teorica: [
    { label: "— Subcapa —", value: "" },
    { label: "Gobernanza IA comparada",              value: "Gobernanza IA comparada" },
    { label: "Metodología derecho comparado",        value: "Metodología derecho comparado" },
    { label: "Contestabilidad algorítmica",          value: "Contestabilidad algorítmica" },
    { label: "Derecho procesal y prueba electrónica",value: "Derecho procesal y prueba electrónica" },
  ],
  analitica: [
    { label: "— Subcapa —", value: "" },
    { label: "Art. 9 · MAP/MEASURE",    value: "Art. 9 ↔ MAP/MEASURE" },
    { label: "Art. 10 · MAP/GOVERN",    value: "Art. 10 ↔ MAP/GOVERN" },
    { label: "Art. 11 · GOVERN",        value: "Art. 11 ↔ GOVERN" },
    { label: "Art. 12 · MEASURE",       value: "Art. 12 ↔ MEASURE" },
    { label: "Art. 13 · GOVERN/MAP",    value: "Art. 13 ↔ GOVERN/MAP" },
    { label: "Art. 14 · GOVERN/MANAGE", value: "Art. 14 ↔ GOVERN/MANAGE" },
    { label: "Art. 15 · MEASURE/MANAGE",value: "Art. 15 ↔ MEASURE/MANAGE" },
  ],
  evaluativa: [
    { label: "— Subcapa —", value: "" },
    { label: "Contestabilidad algorítmica",          value: "Contestabilidad algorítmica" },
    { label: "Derecho procesal y prueba electrónica",value: "Derecho procesal y prueba electrónica" },
  ],
  metodologica: [
    { label: "— Subcapa —", value: "" },
    { label: "Gobernanza IA comparada",              value: "Gobernanza IA comparada" },
    { label: "Metodología derecho comparado",        value: "Metodología derecho comparado" },
    { label: "Contestabilidad algorítmica",          value: "Contestabilidad algorítmica" },
    { label: "Derecho procesal y prueba electrónica",value: "Derecho procesal y prueba electrónica" },
    { label: "Metodología de investigación",         value: "Metodología de investigación doctoral" },
  ],
};

let state = {
  page: 1, search: "", importance: "", capa: "", capaKey: "",
  sort: "found-desc", starFilter: false,
  rows: [], total: 0, total_pages: 1, has_next: false, has_prev: false,
  loading: false, lastFetch: null,
};
let expandedIds = new Set();

// ── Subcapa dropdown sync ─────────────────────────────────────────────────────
function buildSubcapaDropdown(capaKey) {
  const sel = document.getElementById("selCapaDetail");
  const currentVal = sel.value;
  sel.innerHTML = "";

  const key = capaKey || "all";
  const items = SUBCAPA_OPTIONS[key] || SUBCAPA_OPTIONS.all;

  for (const item of items) {
    if (item.group) {
      const grp = document.createElement("optgroup");
      grp.label = item.group;
      for (const opt of item.options) {
        const o = document.createElement("option");
        o.value = opt.value; o.textContent = opt.label;
        if (o.value === currentVal) o.selected = true;
        grp.appendChild(o);
      }
      sel.appendChild(grp);
    } else {
      const o = document.createElement("option");
      o.value = item.value; o.textContent = item.label;
      if (o.value === currentVal) o.selected = true;
      sel.appendChild(o);
    }
  }

  if (sel.value !== currentVal) sel.value = "";
  updateDropdownStyle(sel);
}

function updateDropdownStyle(sel) {
  if (sel.value) sel.classList.add("filter-active");
  else sel.classList.remove("filter-active");
}

// ── Star filter toggle ────────────────────────────────────────────────────────
function toggleStarFilter() {
  state.starFilter = !state.starFilter;
  const btn = document.getElementById("btnStarFilter");
  if (state.starFilter) btn.classList.add("active");
  else btn.classList.remove("active");
  state.page = 1;
  updateClearBtn();
  fetchData();
}

// ── URL builder ───────────────────────────────────────────────────────────────
function buildUrl() {
  let url = API_URL + "?action=getPage"
    + "&page=" + state.page
    + "&limit=" + PAGE_LIMIT
    + "&sort=" + encodeURIComponent(state.sort);
  if (state.importance) url += "&importance=" + encodeURIComponent(state.importance);
  if (state.capa)       url += "&capa="       + encodeURIComponent(state.capa);
  const cd = document.getElementById("selCapaDetail").value;
  if (cd) url += "&capa_detail=" + encodeURIComponent(cd);
  const ev = document.getElementById("selEvaluativa").value;
  const tp = document.getElementById("selType").value;
  // Star filter: pass starred=1 as a search term on the starred column
  // We handle it client-side after fetch since the API doesn't have a starred param yet.
  // (See filterStarred below.)
  const extra = [ev, tp].filter(Boolean).join(" ");
  const combined = [state.search, extra].filter(Boolean).join(" ");
  if (combined) url += "&search=" + encodeURIComponent(combined);
  return url;
}

// ── JSONP ──────────────────────────────────────────────────────────────────────
function jsonp(url) {
  return new Promise((resolve, reject) => {
    const cbName = "_cb_" + Math.random().toString(36).slice(2);
    const timer = setTimeout(() => { delete window[cbName]; reject(new Error("Timeout")); }, 25000);
    window[cbName] = data => { clearTimeout(timer); delete window[cbName]; resolve(data); };
    const s = document.createElement("script");
    s.src = url + "&callback=" + cbName;
    s.onerror = () => { clearTimeout(timer); delete window[cbName]; reject(new Error("Network error")); };
    document.head.appendChild(s);
  });
}

// ── Button counts ─────────────────────────────────────────────────────────────
function updateAllButtonCounts(stats) {
  if (!stats) return;
  ["ALTA","MEDIA","BAJA"].forEach(k => {
    const el = document.getElementById("cnt-" + k);
    if (el) el.textContent = stats[k.toLowerCase()] !== undefined ? stats[k.toLowerCase()] : "—";
  });
}

// ── Fetch ─────────────────────────────────────────────────────────────────────
async function fetchData() {
  if (state.loading) return;
  state.loading = true;
  setRefreshBtn(true);
  renderMain('<div class="state-msg">Loading…</div>');
  document.getElementById("pagination").innerHTML = "";
  try {
    const data = await jsonp(buildUrl());
    if (data.error) throw new Error(data.error);

    // Apply client-side star filter if active
    // The API returns all rows; we filter here since the Apps Script doesn't
    // have a `starred` parameter. For large datasets this is fine since
    // PAGE_LIMIT caps the payload; starred filter narrows display only.
    let rows = data.rows || [];
    if (state.starFilter) {
      rows = rows.filter(r => r.starred === "1" || r.starred === "true" || r.starred === "yes");
    }

    state.total       = state.starFilter ? rows.length : data.total;
    state.total_pages = state.starFilter ? Math.max(1, Math.ceil(rows.length / PAGE_LIMIT)) : data.total_pages;
    state.has_next    = state.starFilter ? false : data.has_next;
    state.has_prev    = state.starFilter ? false : data.has_prev;
    state.page        = data.page || state.page;
    state.lastFetch   = new Date();
    state.rows        = rows;
    renderHeader(data.stats || null);
    updateAllButtonCounts(data.stats || null);
    renderFlat();
    renderPagination();
  } catch(e) {
    renderMain(`<div class="error-box"><strong>Could not load data.</strong> ${e.message}</div>`);
  }
  state.loading = false;
  setRefreshBtn(false);
  if (state.lastFetch)
    document.getElementById("lastFetch").textContent =
      state.lastFetch.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
}

function refresh() { fetchData(); }

// ── Star toggle on individual card ────────────────────────────────────────────
function toggleStar(event, url, cardStarBtnId) {
  event.stopPropagation(); // don't expand the card

  const btn = document.getElementById(cardStarBtnId);
  if (!btn) return;

  const isStarred = btn.classList.contains("starred");
  const newVal = isStarred ? "" : "1";

  // Optimistic UI
  btn.classList.add("saving");
  btn.classList.toggle("starred", !isStarred);
  btn.title = !isStarred ? "Unstar" : "Star";

  // Use JSONP for the write — avoids CORS issues with Apps Script
  const fieldsJson = JSON.stringify({ starred: newVal });
  const writeUrl = API_URL
    + "?action=updateByUrl"
    + "&url=" + encodeURIComponent(url)
    + "&fields=" + encodeURIComponent(fieldsJson);

  jsonp(writeUrl).then(result => {
    if (result.error) throw new Error(result.error);

    // Update local state so re-renders stay consistent
    const row = state.rows.find(r => r.url === url);
    if (row) row.starred = newVal;

    // If star filter is active and we just unstarred, remove from view
    if (state.starFilter && !newVal) {
      state.rows = state.rows.filter(r => r.url !== url);
      state.total = state.rows.length;
      renderFlat();
    }
  }).catch(e => {
    // Revert optimistic update on failure
    btn.classList.toggle("starred", isStarred);
    btn.title = isStarred ? "Unstar" : "Star";
    console.error("Star save failed:", e.message);
    alert("Could not save star: " + e.message);
  }).finally(() => {
    btn.classList.remove("saving");
  });
}

// ── Filters ───────────────────────────────────────────────────────────────────
function toggleImp(imp) {
  ["ALTA","MEDIA","BAJA"].forEach(i => {
    const btn = document.getElementById("btn-" + i);
    const wasActive = btn.classList.contains("active-" + i);
    btn.className = "btn-imp" + (i === imp && !wasActive ? " active-" + i : "");
  });
  state.importance = document.getElementById("btn-ALTA").classList.contains("active-ALTA")   ? "ALTA"
                   : document.getElementById("btn-MEDIA").classList.contains("active-MEDIA") ? "MEDIA"
                   : document.getElementById("btn-BAJA").classList.contains("active-BAJA")   ? "BAJA" : "";
  state.page = 1; updateClearBtn(); fetchData();
}

function toggleCapa(capa) {
  const capaKeys = ["teorica","analitica","evaluativa","metodologica"];
  let newCapaKey = "";
  capaKeys.forEach(c => {
    const btn = document.getElementById("btn-" + c);
    const wasActive = btn.classList.contains("active-" + c);
    const isThis = c === capa;
    btn.className = "btn-capa" + (isThis && !wasActive ? " active-" + c : "");
    if (isThis && !wasActive) newCapaKey = c;
  });

  const capaValueMap = {
    teorica: "teórica", analitica: "analítica",
    evaluativa: "evaluativa", metodologica: "metodológica"
  };
  state.capaKey = newCapaKey;
  state.capa    = newCapaKey ? (capaValueMap[newCapaKey] || newCapaKey) : "";

  buildSubcapaDropdown(newCapaKey);
  state.page = 1; updateClearBtn(); fetchData();
}

function applyDropdown() {
  updateDropdownStyle(document.getElementById("selCapaDetail"));
  updateDropdownStyle(document.getElementById("selEvaluativa"));
  updateDropdownStyle(document.getElementById("selType"));
  state.page = 1; updateClearBtn(); fetchData();
}

function applySort() {
  state.sort = document.getElementById("selSort").value;
  state.page = 1; fetchData();
}

function submitSearch() {
  state.search = document.getElementById("searchInput").value.trim();
  state.page = 1; updateXBtn(); updateClearBtn(); fetchData();
}

function clearSearch() {
  document.getElementById("searchInput").value = "";
  state.search = ""; state.page = 1; updateXBtn(); updateClearBtn(); fetchData();
}

function clearAllFilters() {
  document.getElementById("searchInput").value = "";
  document.getElementById("selSort").value = "found-desc";
  document.getElementById("selEvaluativa").value = "";
  document.getElementById("selType").value = "";
  ["ALTA","MEDIA","BAJA"].forEach(i => document.getElementById("btn-" + i).className = "btn-imp");
  ["teorica","analitica","evaluativa","metodologica"].forEach(c =>
    document.getElementById("btn-" + c).className = "btn-capa"
  );
  state.search = ""; state.importance = ""; state.capa = ""; state.capaKey = "";
  state.sort = "found-desc"; state.page = 1; state.starFilter = false;
  document.getElementById("btnStarFilter").classList.remove("active");
  buildSubcapaDropdown("");
  updateXBtn(); updateClearBtn(); fetchData();
}

function updateXBtn() {
  const val = document.getElementById("searchInput").value;
  document.getElementById("btnClearX").style.display = val ? "block" : "none";
}

function updateClearBtn() {
  const cd = document.getElementById("selCapaDetail").value;
  const ev = document.getElementById("selEvaluativa").value;
  const tp = document.getElementById("selType").value;
  const active = state.importance || state.capa || state.search || cd || ev || tp || state.starFilter;
  document.getElementById("btnClearAll").style.display = active ? "inline" : "none";
}

function goPage(p) { state.page = p; fetchData(); }

// ── Render ────────────────────────────────────────────────────────────────────
function renderHeader(stats) {
  const el = document.getElementById("headerStats");
  const hasFilter = state.importance || state.capa || state.search || state.starFilter
    || document.getElementById("selCapaDetail").value
    || document.getElementById("selEvaluativa").value
    || document.getElementById("selType").value;
  if (stats) {
    el.innerHTML = `
      <span><strong>${stats.total_all}</strong> sources</span>
      <span style="color:#DC2626;font-weight:700">${stats.alta} Alta</span>
      <span style="color:#D97706;font-weight:700">${stats.media} Media</span>
      <span style="color:#9CA3AF;font-weight:700">${stats.baja} Baja</span>
      ${hasFilter ? `<span>· <strong>${state.total}</strong> matching</span>` : ""}
    `;
  } else {
    el.innerHTML = `<span><strong>${state.total}</strong> ${hasFilter ? "matching" : "total"} sources</span>`;
  }
  document.getElementById("filterCount").textContent = state.total_pages > 1
    ? `Page ${state.page} of ${state.total_pages} · ${state.total} items` : `${state.total} items`;
}

function renderFlat() {
  if (!state.rows.length) { renderMain('<div class="state-msg">No results.</div>'); return; }
  renderMain(state.rows.map((item, i) => renderCard(item, "c-" + state.page + "-" + i)).join(""));
}

// ── Card ──────────────────────────────────────────────────────────────────────
function renderCard(item, id) {
  const imp    = item.importance || "BAJA";
  const isOpen = expandedIds.has(id);
  const isStarred = item.starred === "1" || item.starred === "true" || item.starred === "yes";
  const starBtnId = "star-" + id;
  // Escape url for inline handler
  const urlEscaped = (item.url || "").replace(/'/g, "\\'");

  const metaParts = [];

  // Star button — first in meta line, before importance badge
  const starBtn = `<button
    class="btn-star${isStarred ? " starred" : ""}"
    id="${starBtnId}"
    title="${isStarred ? "Unstar" : "Star"}"
    onclick="toggleStar(event, '${urlEscaped}', '${starBtnId}')"
  >★</button>`;

  const capaRaw = (item.capa || "").toLowerCase();
  const capaClass = capaRaw.includes("teór") || capaRaw.includes("teor")   ? "meta-capa-teorica"
                  : capaRaw.includes("analí") || capaRaw.includes("anali") ? "meta-capa-analitica"
                  : capaRaw.includes("eval")                                ? "meta-capa-evaluativa"
                  : capaRaw.includes("metod")                               ? "meta-capa-metodologica" : "";
  const capaLabel = capaRaw.includes("teór") || capaRaw.includes("teor")   ? "Teórica"
                  : capaRaw.includes("analí") || capaRaw.includes("anali") ? "Analítica"
                  : capaRaw.includes("eval")                                ? "Evaluativa"
                  : capaRaw.includes("metod")                               ? "Metodológica"
                  : item.capa || "";
  if (capaLabel) metaParts.push(`<span class="${capaClass}">${capaLabel}</span>`);
  if (item.capa_detail)         metaParts.push(`<span class="meta-capa-detail">${item.capa_detail}</span>`);
  if (item.evaluativa_criteria) metaParts.push(`<span class="meta-evaluativa">${item.evaluativa_criteria}</span>`);
  const ACT = { REFERENCE: "Reference", CONTEXT: "Context", "FOLLOW-UP": "Follow-up", URGENT: "Urgent" };
  if (item.action_tag)  metaParts.push(`<span class="meta-action">${ACT[item.action_tag] || item.action_tag}</span>`);
  if (item.content_type) metaParts.push(`<span class="meta-type">${item.content_type}</span>`);
  const tier = String(item.tier || "").trim();
  if (tier) metaParts.push(`<span class="meta-tier">T${tier}</span>`);

  const metaLine = metaParts.map((p, i) =>
    i === 0 ? p : `<span class="meta-sep">·</span>${p}`
  ).join("");

  const bylineParts = [
    item.source || "",
    item.date_published ? formatDate(item.date_published) : "",
    item.scholar ? `<span class="scholar">${item.scholar}</span>` : "",
    item.language && item.language !== "en" ? `<span class="lang">${item.language}</span>` : "",
  ].filter(Boolean);
  const byline = bylineParts.join('<span class="meta-sep">·</span>');

  const paras = (item.thesis_relevance || "").split(/\n\n+/).filter(p => p.trim());
  const bodyHtml = paras.map((p, i) =>
    `<p${i === paras.length - 1 ? ' class="thesis"' : ""}>${p}</p>`
  ).join("");
  const link = item.url
    ? `<a class="read-link" href="${item.url}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Read source →</a>`
    : "";

  return `
    <article onclick="toggleCard('${id}')">
      <div class="card-meta">
        ${starBtn}<span class="card-imp imp-${imp}">${{ALTA:"ALTA",MEDIA:"MEDIA",BAJA:"BAJA"}[imp]||imp}</span>${metaLine}
      </div>
      <h2 class="card-title">${item.title || "(no title)"}</h2>
      <div class="card-byline">${byline}</div>
      <div class="card-body${isOpen ? " open" : ""}" id="${id}">
        ${bodyHtml}
        ${link}
      </div>
    </article>`;
}

function toggleCard(id) {
  const el = document.getElementById(id);
  if (!el) return;
  if (expandedIds.has(id)) { expandedIds.delete(id); el.classList.remove("open"); }
  else                     { expandedIds.add(id);    el.classList.add("open");    }
}

function renderMain(html) { document.getElementById("main").innerHTML = html; }

// ── Pagination ────────────────────────────────────────────────────────────────
function renderPagination() {
  const el = document.getElementById("pagination");
  if (state.total_pages <= 1) { el.innerHTML = ""; return; }
  const pages = [];
  for (let i = 1; i <= state.total_pages; i++) {
    if (i === 1 || i === state.total_pages || Math.abs(i - state.page) <= 2) pages.push(i);
  }
  let html = `<button class="btn-page" ${!state.has_prev?"disabled":""} onclick="goPage(${state.page-1})">← Prev</button>`;
  let last = 0;
  for (const p of pages) {
    if (last && p - last > 1) html += `<span class="ellipsis">…</span>`;
    html += `<button class="btn-page${p===state.page?" current":""}" onclick="goPage(${p})">${p}</button>`;
    last = p;
  }
  html += `<button class="btn-page" ${!state.has_next?"disabled":""} onclick="goPage(${state.page+1})">Next →</button>`;
  el.innerHTML = html;
}

function setRefreshBtn(loading) {
  const btn = document.getElementById("btnRefresh");
  btn.textContent = loading ? "↻ …" : "↻ Refresh";
  btn.disabled = loading;
}

function formatDate(d) {
  if (!d) return "";
  const dt = new Date(d);
  if (isNaN(dt)) return String(d);
  return dt.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" });
}

function exportMarkdown() {
  if (!state.rows.length) { alert("Nothing to export."); return; }
  const lines = ["# Thesis Knowledge Base Export", `_${new Date().toLocaleDateString()}_`, ""];
  for (const item of state.rows) {
    const starred = (item.starred === "1" || item.starred === "true") ? "★ " : "";
    lines.push(`## ${starred}${item.title || "(no title)"}`);
    lines.push(`**${item.importance}** · ${item.capa || ""} · ${item.capa_detail || ""} · ${item.evaluativa_criteria || ""}`);
    lines.push(`${item.source || ""} · ${formatDate(item.date_published)} · ${item.content_type || ""}`);
    if (item.scholar) lines.push(`Scholar: ${item.scholar}`);
    lines.push("");
    if (item.thesis_relevance) lines.push(item.thesis_relevance);
    if (item.url) lines.push(`\n[Source](${item.url})`);
    lines.push("\n---\n");
  }
  const text = lines.join("\n");
  navigator.clipboard.writeText(text)
    .then(() => alert("Copied ✓"))
    .catch(() => {
      const ta = document.createElement("textarea");
      ta.value = text; document.body.appendChild(ta);
      ta.select(); document.execCommand("copy");
      document.body.removeChild(ta); alert("Copied ✓");
    });
}

// ── Init ──────────────────────────────────────────────────────────────────────
buildSubcapaDropdown("");
fetchData();
</script>
</body>
</html>
